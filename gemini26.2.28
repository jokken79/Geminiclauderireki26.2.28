import React, { useState, useMemo } from 'react';
import { 
  Users, FileText, Briefcase, Building, AlertTriangle, 
  CheckCircle, Clock, Search, Plus, FileSignature, 
  ShieldAlert, ChevronRight, UserCircle, Download
} from 'lucide-react';

// --- UTILIDADES ---
const toWareki = (dateString) => {
  if (!dateString) return '';
  const date = new Date(dateString);
  const year = date.getFullYear();
  if (year >= 2019) return `令和${year - 2018}年`;
  if (year >= 1989) return `平成${year - 1988}年`;
  if (year >= 1926) return `昭和${year - 1925}年`;
  if (year >= 1912) return `大正${year - 1911}年`;
  return `明治${year - 1867}年`;
};

const getAgeRange = (birthDateString) => {
  if (!birthDateString) return '不明';
  const age = new Date().getFullYear() - new Date(birthDateString).getFullYear();
  const decade = Math.floor(age / 10) * 10;
  const half = age % 10 < 5 ? '前半' : '後半';
  return `${decade}代${half}`;
};

const getInitials = (lastName, firstName) => {
  return `${lastName ? lastName.charAt(0) : ''}.${firstName ? firstName.charAt(0) : ''}`;
};

// --- DATOS MOCK INICIALES ---
const mockClients = [
  { id: 'C1', name: 'Toyota Auto Body', industry: 'Manufactura', location: 'Aichi' },
  { id: 'C2', name: 'Sony Electronics', industry: 'Electrónica', location: 'Tokyo' },
];

const mockCandidates = [
  {
    id: 'RK-001',
    status: 'pending',
    lastName: '田中', firstName: '太郎',
    lastNameKana: 'タナカ', firstNameKana: 'タロウ',
    lastNameRomaji: 'Tanaka', firstNameRomaji: 'Taro',
    birthDate: '1990-05-15',
    gender: 'Masculino',
    nationality: 'Japón',
    phone: '090-1234-5678',
    email: 'tanaka@example.com',
    japaneseLevel: 'Native',
    address: '愛知県豊田市...',
    skills: ['Montaje de vehículos', 'Inspección visual'],
    visaExpiry: '2030-01-01',
    createdAt: '2024-10-01',
  },
  {
    id: 'RK-002',
    status: 'approved',
    lastName: 'García', firstName: 'Carlos',
    lastNameKana: 'ガルシア', firstNameKana: 'カルロス',
    lastNameRomaji: 'Garcia', firstNameRomaji: 'Carlos',
    birthDate: '1985-11-20',
    gender: 'Masculino',
    nationality: 'Perú',
    phone: '080-9876-5432',
    email: 'carlos@example.com',
    japaneseLevel: 'N3',
    address: '静岡県浜松市...',
    skills: ['Soldadura', 'Montacargas (Forklift)'],
    visaExpiry: '2024-12-01', // Próxima a vencer
    createdAt: '2024-10-15',
  }
];

const mockEmployees = [
  {
    id: 'EMP-001',
    candidateId: 'RK-003',
    type: 'hakenshain', // 派遣社員
    name: 'Suzuki Ichiro',
    clientId: 'C1',
    hireDate: '2021-11-01', // Cerca de los 3 años (Teishoku-bi)
    hourlyWage: 1500,
    supervisor: 'Takahashi (Cliente)',
  },
  {
    id: 'EMP-002',
    candidateId: 'RK-004',
    type: 'ukeoi', // 請負
    name: 'Lima Maria',
    clientId: 'C2',
    hireDate: '2023-04-01',
    monthlySalary: 250000,
    ourSupervisor: 'Sato (Interno)', // Crucial para Ukeoi
  }
];

// --- COMPONENTES PRINCIPALES ---

export default function HRSystem() {
  const [currentView, setCurrentView] = useState('dashboard');
  const [candidates, setCandidates] = useState(mockCandidates);
  const [employees, setEmployees] = useState(mockEmployees);
  const [selectedItem, setSelectedItem] = useState(null);

  // --- VISTAS ---

  const renderSidebar = () => (
    <div className="w-64 bg-slate-900 text-slate-300 flex flex-col h-full shadow-2xl z-10">
      <div className="p-6 flex items-center space-x-3 bg-slate-950">
        <div className="w-10 h-10 bg-indigo-500 rounded-lg flex items-center justify-center">
          <Building className="text-white w-6 h-6" />
        </div>
        <div>
          <h1 className="text-white font-bold text-lg leading-tight">Staffing OS</h1>
          <p className="text-xs text-indigo-300">人材派遣管理システム</p>
        </div>
      </div>
      
      <nav className="flex-1 px-4 py-6 space-y-2">
        {[
          { id: 'dashboard', icon: Clock, label: 'Dashboard' },
          { id: 'candidates', icon: FileText, label: 'Candidatos (履歴書)' },
          { id: 'hakenshain', icon: Briefcase, label: 'Haken (派遣社員)' },
          { id: 'ukeoi', icon: ShieldAlert, label: 'Ukeoi (請負)' },
        ].map((item) => (
          <button
            key={item.id}
            onClick={() => { setCurrentView(item.id); setSelectedItem(null); }}
            className={`w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all ${
              currentView === item.id 
                ? 'bg-indigo-600 text-white shadow-md' 
                : 'hover:bg-slate-800 hover:text-white'
            }`}
          >
            <item.icon className="w-5 h-5" />
            <span className="font-medium">{item.label}</span>
          </button>
        ))}
      </nav>
      
      <div className="p-4 bg-slate-800 m-4 rounded-xl flex items-center space-x-3">
        <UserCircle className="w-10 h-10 text-slate-400" />
        <div>
          <p className="text-sm font-semibold text-white">Admin User</p>
          <p className="text-xs text-slate-400">管理者</p>
        </div>
      </div>
    </div>
  );

  const renderDashboard = () => {
    // Alertas mockeadas basadas en reglas de negocio
    const expiringVisas = candidates.filter(c => new Date(c.visaExpiry) < new Date('2025-01-01'));
    const teishokubiAlerts = employees.filter(e => e.type === 'hakenshain' && e.hireDate < '2022-01-01');

    return (
      <div className="p-8 space-y-8 animate-in fade-in">
        <div>
          <h2 className="text-3xl font-bold text-slate-800">Dashboard</h2>
          <p className="text-slate-500 mt-1">Resumen del sistema y alertas de compliance (法令遵守)</p>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center space-x-4">
            <div className="p-4 bg-blue-50 text-blue-600 rounded-xl"><FileText className="w-8 h-8" /></div>
            <div>
              <p className="text-sm font-medium text-slate-500">Nuevos Rirekishos</p>
              <p className="text-3xl font-bold text-slate-800">{candidates.filter(c=>c.status==='pending').length}</p>
            </div>
          </div>
          <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center space-x-4">
            <div className="p-4 bg-indigo-50 text-indigo-600 rounded-xl"><Briefcase className="w-8 h-8" /></div>
            <div>
              <p className="text-sm font-medium text-slate-500">Haken Activos (派遣)</p>
              <p className="text-3xl font-bold text-slate-800">{employees.filter(e=>e.type==='hakenshain').length}</p>
            </div>
          </div>
          <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center space-x-4">
            <div className="p-4 bg-emerald-50 text-emerald-600 rounded-xl"><ShieldAlert className="w-8 h-8" /></div>
            <div>
              <p className="text-sm font-medium text-slate-500">Ukeoi Activos (請負)</p>
              <p className="text-3xl font-bold text-slate-800">{employees.filter(e=>e.type==='ukeoi').length}</p>
            </div>
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
          {/* Alertas Legales */}
          <div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
            <div className="px-6 py-4 border-b border-slate-100 bg-red-50 flex items-center space-x-2">
              <AlertTriangle className="w-5 h-5 text-red-600" />
              <h3 className="font-semibold text-red-900">Alertas de Compliance (法令遵守アラート)</h3>
            </div>
            <div className="p-6 space-y-4">
              {teishokubiAlerts.map(emp => (
                <div key={emp.id} className="flex items-start space-x-3 p-4 bg-orange-50 rounded-xl border border-orange-100">
                  <Clock className="w-5 h-5 text-orange-500 mt-0.5" />
                  <div>
                    <p className="font-medium text-orange-900">Límite de 3 años próximo (抵触日)</p>
                    <p className="text-sm text-orange-700">{emp.name} fue asignado el {emp.hireDate}. Requiere revisión de contrato indefinido o cambio de asignación.</p>
                  </div>
                </div>
              ))}
              {expiringVisas.map(cand => (
                <div key={cand.id} className="flex items-start space-x-3 p-4 bg-yellow-50 rounded-xl border border-yellow-100">
                  <FileSignature className="w-5 h-5 text-yellow-600 mt-0.5" />
                  <div>
                    <p className="font-medium text-yellow-900">Visa por vencer (在留期限)</p>
                    <p className="text-sm text-yellow-700">{cand.lastName} {cand.firstName} - Vence: {cand.visaExpiry}</p>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    );
  };

  const renderCandidates = () => {
    if (selectedItem) return renderCandidateDetail(selectedItem);

    return (
      <div className="p-8 space-y-6 animate-in fade-in">
        <div className="flex justify-between items-end">
          <div>
            <h2 className="text-3xl font-bold text-slate-800">Candidatos (履歴書)</h2>
            <p className="text-slate-500 mt-1">Gestión de currículums, OCR y aprobaciones</p>
          </div>
          <button className="bg-indigo-600 text-white px-5 py-2.5 rounded-xl font-medium flex items-center space-x-2 hover:bg-indigo-700 transition">
            <Plus className="w-5 h-5" />
            <span>Nuevo Rirekisho</span>
          </button>
        </div>

        <div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
          <div className="p-4 border-b border-slate-100 flex items-center space-x-4 bg-slate-50">
            <div className="relative flex-1 max-w-md">
              <Search className="w-5 h-5 text-slate-400 absolute left-3 top-1/2 transform -translate-y-1/2" />
              <input 
                type="text" 
                placeholder="Buscar por nombre, kana o romaji..." 
                className="w-full pl-10 pr-4 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
              />
            </div>
          </div>
          <table className="w-full text-left border-collapse">
            <thead>
              <tr className="bg-white border-b border-slate-100 text-sm text-slate-500">
                <th className="px-6 py-4 font-medium">ID / Nombre</th>
                <th className="px-6 py-4 font-medium">Nacionalidad</th>
                <th className="px-6 py-4 font-medium">Idioma JP</th>
                <th className="px-6 py-4 font-medium">Estado</th>
                <th className="px-6 py-4 font-medium text-right">Acción</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-slate-100">
              {candidates.map(cand => (
                <tr key={cand.id} className="hover:bg-slate-50 transition cursor-pointer" onClick={() => setSelectedItem(cand)}>
                  <td className="px-6 py-4">
                    <p className="font-semibold text-slate-800">{cand.lastName} {cand.firstName}</p>
                    <p className="text-xs text-slate-500">{cand.lastNameKana} {cand.firstNameKana} | {cand.id}</p>
                  </td>
                  <td className="px-6 py-4 text-slate-600">{cand.nationality}</td>
                  <td className="px-6 py-4 text-slate-600">{cand.japaneseLevel}</td>
                  <td className="px-6 py-4">
                    <span className={`px-3 py-1 text-xs font-semibold rounded-full ${
                      cand.status === 'pending' ? 'bg-amber-100 text-amber-700' :
                      cand.status === 'approved' ? 'bg-emerald-100 text-emerald-700' :
                      'bg-slate-100 text-slate-700'
                    }`}>
                      {cand.status === 'pending' ? 'Pendiente (保留中)' : 'Aprobado (承認済)'}
                    </span>
                  </td>
                  <td className="px-6 py-4 text-right">
                    <ChevronRight className="w-5 h-5 text-slate-400 inline" />
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    );
  };

  const renderCandidateDetail = (cand) => {
    return (
      <div className="p-8 space-y-6 animate-in slide-in-from-right-4">
        <button 
          onClick={() => setSelectedItem(null)}
          className="text-indigo-600 font-medium hover:underline flex items-center space-x-1"
        >
          <span>← Volver a la lista</span>
        </button>

        <div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
          <div className="p-8 border-b border-slate-100 flex items-start justify-between bg-slate-50">
            <div className="flex items-center space-x-6">
              <div className="w-24 h-32 bg-slate-200 border-4 border-white shadow-md rounded-lg flex items-center justify-center relative overflow-hidden">
                <span className="text-slate-400 text-sm text-center px-2">Foto 3x4cm<br/>(写真)</span>
              </div>
              <div>
                <div className="flex items-center space-x-3 mb-1">
                  <h2 className="text-3xl font-bold text-slate-800">{cand.lastName} {cand.firstName}</h2>
                  <span className={`px-3 py-1 text-xs font-semibold rounded-full ${
                    cand.status === 'pending' ? 'bg-amber-100 text-amber-700' : 'bg-emerald-100 text-emerald-700'
                  }`}>
                    {cand.status === 'pending' ? 'Pendiente' : 'Aprobado'}
                  </span>
                </div>
                <p className="text-slate-500 mb-2">{cand.lastNameKana} {cand.firstNameKana} / {cand.lastNameRomaji} {cand.firstNameRomaji}</p>
                <div className="flex items-center space-x-4 text-sm text-slate-600">
                  <span className="bg-slate-100 px-2 py-1 rounded">Nacimiento: {cand.birthDate} ({toWareki(cand.birthDate)})</span>
                  <span className="bg-slate-100 px-2 py-1 rounded">{cand.nationality}</span>
                  <span className="bg-slate-100 px-2 py-1 rounded">{cand.gender}</span>
                </div>
              </div>
            </div>
            
            <div className="flex flex-col space-y-2">
              {cand.status === 'pending' && (
                <button 
                  onClick={() => {
                    const newCands = candidates.map(c => c.id === cand.id ? {...c, status: 'approved'} : c);
                    setCandidates(newCands);
                    setSelectedItem({...cand, status: 'approved'});
                  }}
                  className="bg-emerald-600 text-white px-6 py-2 rounded-xl font-medium hover:bg-emerald-700 shadow-sm"
                >
                  Aprobar Candidato (承認)
                </button>
              )}
              {cand.status === 'approved' && (
                <button 
                  onClick={() => alert('Abriendo modal de Nyusha Todoke (入社連絡票)...')}
                  className="bg-indigo-600 text-white px-6 py-2 rounded-xl font-medium hover:bg-indigo-700 shadow-sm"
                >
                  Asignar a Puesto (入社連絡票)
                </button>
              )}
              <button onClick={() => alert('Generando PDF...')} className="bg-white border border-slate-200 text-slate-700 px-6 py-2 rounded-xl font-medium hover:bg-slate-50 shadow-sm flex items-center justify-center space-x-2">
                <FileText className="w-4 h-4" /> <span>Skill Sheet (スキルシート)</span>
              </button>
            </div>
          </div>

          <div className="p-8 grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div className="space-y-6">
              <div>
                <h3 className="text-lg font-bold text-slate-800 border-b pb-2 mb-4">Información de Contacto (連絡先)</h3>
                <div className="space-y-3 text-sm">
                  <div className="grid grid-cols-3"><span className="text-slate-500 font-medium">Teléfono:</span> <span className="col-span-2 font-medium">{cand.phone}</span></div>
                  <div className="grid grid-cols-3"><span className="text-slate-500 font-medium">Email:</span> <span className="col-span-2 font-medium">{cand.email}</span></div>
                  <div className="grid grid-cols-3"><span className="text-slate-500 font-medium">Dirección:</span> <span className="col-span-2 font-medium">{cand.address}</span></div>
                </div>
              </div>
              
              <div>
                <h3 className="text-lg font-bold text-slate-800 border-b pb-2 mb-4">Inmigración y Visas (在留資格)</h3>
                <div className="space-y-3 text-sm">
                  <div className="grid grid-cols-3"><span className="text-slate-500 font-medium">Vencimiento Visa:</span> 
                    <span className={`col-span-2 font-bold ${new Date(cand.visaExpiry) < new Date('2025-01-01') ? 'text-red-600' : 'text-emerald-600'}`}>
                      {cand.visaExpiry} {new Date(cand.visaExpiry) < new Date('2025-01-01') ? '(Vence pronto)' : ''}
                    </span>
                  </div>
                  <div className="grid grid-cols-3"><span className="text-slate-500 font-medium">Nivel Japonés:</span> <span className="col-span-2 font-medium bg-indigo-50 text-indigo-700 px-2 py-0.5 rounded inline-block w-max">{cand.japaneseLevel}</span></div>
                </div>
              </div>
            </div>

            <div className="space-y-6">
              <div>
                <h3 className="text-lg font-bold text-slate-800 border-b pb-2 mb-4">Habilidades (経験作業)</h3>
                <div className="flex flex-wrap gap-2">
                  {cand.skills.map(s => (
                    <span key={s} className="bg-slate-100 border border-slate-200 text-slate-700 px-3 py-1 rounded-lg text-sm font-medium">
                      {s}
                    </span>
                  ))}
                </div>
              </div>
              
              <div className="bg-blue-50 p-5 rounded-xl border border-blue-100">
                <h4 className="font-bold text-blue-900 flex items-center mb-2">
                  <ShieldAlert className="w-5 h-5 mr-2" /> Privacidad Legal (労働者派遣法26条)
                </h4>
                <p className="text-sm text-blue-800 mb-3">
                  Al generar el Skill Sheet para empresas cliente, el sistema anonimizará automáticamente:
                </p>
                <ul className="list-disc pl-5 text-sm text-blue-800 space-y-1">
                  <li>Nombre completo → Iniciales ({getInitials(cand.lastNameRomaji, cand.firstNameRomaji)})</li>
                  <li>Fecha nacimiento → Rango ({getAgeRange(cand.birthDate)})</li>
                  <li>Dirección exacta → Solo prefectura/ciudad</li>
                  <li>La foto será excluida del documento.</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  };

  const renderEmployees = (type) => {
    const list = employees.filter(e => e.type === type);
    const isUkeoi = type === 'ukeoi';

    return (
      <div className="p-8 space-y-6 animate-in fade-in">
        <div>
          <h2 className="text-3xl font-bold text-slate-800">
            {isUkeoi ? 'Trabajadores por Contrato (請負)' : 'Trabajadores Despachados (派遣社員)'}
          </h2>
          <p className="text-slate-500 mt-1">
            {isUkeoi ? 'Gestión de proyectos y resultados internos.' : 'Gestión de asignaciones en empresas cliente y gestión de tiempos.'}
          </p>
        </div>

        {isUkeoi && (
          <div className="bg-amber-50 border-l-4 border-amber-500 p-4 rounded-r-xl flex items-start space-x-3">
            <AlertTriangle className="w-6 h-6 text-amber-600 flex-shrink-0" />
            <div>
              <h3 className="font-bold text-amber-900">Advertencia Legal: Gisou Ukeoi (偽装請負)</h3>
              <p className="text-sm text-amber-800 mt-1">
                En la modalidad <strong>Ukeoi</strong>, la empresa cliente NO PUEDE dar instrucciones directas al trabajador. 
                El sistema exige el registro de un <strong>Supervisor Interno (自社の現場責任者)</strong> para todo trabajador en esta modalidad.
              </p>
            </div>
          </div>
        )}

        <div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
          <table className="w-full text-left border-collapse">
            <thead>
              <tr className="bg-slate-50 border-b border-slate-100 text-sm text-slate-500">
                <th className="px-6 py-4 font-medium">ID / Nombre</th>
                <th className="px-6 py-4 font-medium">Empresa Cliente</th>
                <th className="px-6 py-4 font-medium">Fecha Ingreso</th>
                <th className="px-6 py-4 font-medium">
                  {isUkeoi ? 'Supervisor Interno' : 'Supervisor (Cliente)'}
                </th>
                <th className="px-6 py-4 font-medium text-right">Contrato</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-slate-100">
              {list.map(emp => {
                const client = mockClients.find(c => c.id === emp.clientId);
                return (
                  <tr key={emp.id} className="hover:bg-slate-50 transition">
                    <td className="px-6 py-4">
                      <p className="font-semibold text-slate-800">{emp.name}</p>
                      <p className="text-xs text-slate-500">{emp.id} | Cand: {emp.candidateId}</p>
                    </td>
                    <td className="px-6 py-4">
                      <p className="font-medium text-slate-700">{client?.name}</p>
                      <p className="text-xs text-slate-500">{client?.location}</p>
                    </td>
                    <td className="px-6 py-4 text-slate-600">{emp.hireDate}</td>
                    <td className="px-6 py-4">
                      <span className={`px-3 py-1 text-xs font-semibold rounded-full ${isUkeoi ? 'bg-indigo-100 text-indigo-800 border border-indigo-200' : 'bg-slate-100 text-slate-700'}`}>
                        {isUkeoi ? emp.ourSupervisor : emp.supervisor}
                      </span>
                    </td>
                    <td className="px-6 py-4 text-right">
                      <button className="text-indigo-600 hover:text-indigo-800 font-medium text-sm">Ver Detalles</button>
                    </td>
                  </tr>
                );
              })}
              {list.length === 0 && (
                <tr>
                  <td colSpan="5" className="px-6 py-8 text-center text-slate-500">No hay trabajadores en esta modalidad.</td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </div>
    );
  };

  // --- RENDER PRINCIPAL ---
  return (
    <div className="flex h-screen bg-slate-50 font-sans text-slate-900">
      {renderSidebar()}
      
      <div className="flex-1 flex flex-col overflow-hidden">
        {/* Top Header Mock */}
        <header className="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 z-0">
          <div className="flex items-center space-x-2 text-sm font-medium text-slate-500">
            <span>Sistema Central</span>
            <ChevronRight className="w-4 h-4" />
            <span className="text-indigo-600 capitalize">{currentView.replace('-', ' ')}</span>
          </div>
          <div className="flex items-center space-x-4">
            <span className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
            <span className="text-sm font-medium text-slate-600">DB Sincronizada</span>
          </div>
        </header>

        <main className="flex-1 overflow-y-auto">
          {currentView === 'dashboard' && renderDashboard()}
          {currentView === 'candidates' && renderCandidates()}
          {currentView === 'hakenshain' && renderEmployees('hakenshain')}
          {currentView === 'ukeoi' && renderEmployees('ukeoi')}
        </main>
      </div>
    </div>
  );
}

